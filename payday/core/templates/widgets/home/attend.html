{% load static i18n %}

<div class="row g-3 align-items-center">
    <div class="col-sm-5 border-sm-end px-3">
        <p class="text-muted small text-uppercase fw-bold mb-2">{% trans "Current Status" %}</p>
        
        <div class="d-flex align-items-center mb-3">
            <div class="rounded-circle me-2 {% if attendance.first_checked_at %}bg-success{% else %}bg-secondary{% endif %}" 
                 style="width: 12px; height: 12px;"></div>
            <h5 class="mb-0 fw-bold">
                {% if attendance.first_checked_at %}{% trans "On Duty" %}{% else %}{% trans "Off Duty" %}{% endif %}
            </h5>
        </div>

        <div class="small">
            <div class="d-flex justify-content-between border-bottom py-1">
                <span class="text-muted">{% trans "In" %}:</span>
                <span class="fw-bold">{{ attendance.first_checked_at|time:"H:i"|default:"--" }}</span>
            </div>
            <div class="d-flex justify-content-between py-1">
                <span class="text-muted">{% trans "Out" %}:</span>
                <span class="fw-bold">{{ attendance.last_checked_at|time:"H:i"|default:"--" }}</span>
            </div>
        </div>
    </div>

    <div class="col-sm-7 text-center border-start-sm">
        <div id="digital-clock" class="h2 fw-bold mb-0 text-primary">00:00:00</div>
        <p class="text-muted small mb-3">{% now "D, d M Y" %}</p>

        <div id="ui-feedback" class="small mb-2" style="min-height: 20px;"></div>

        <div class="position-relative">
            <button id="mainPunchBtn" class="btn btn-lg w-100 fw-bold py-3 shadow-sm border-0 position-relative overflow-hidden">
                <span class="punch-label" style="z-index: 2; position: relative;">{% trans "Wait..." %}</span>
                <div class="punch-progress position-absolute top-0 start-0 h-100 bg-dark opacity-10" 
                     style="width: 0%; transition: width 0.1s linear; z-index: 1;"></div>
            </button>
        </div>
    </div>
</div>

<script>
class AttendanceEngine {
    constructor(options) {
        this.options = options;
        this.btn = document.getElementById('mainPunchBtn');
        this.bar = this.btn.querySelector('.punch-progress');
        this.label = this.btn.querySelector('.punch-label');
        this.clock = document.getElementById('digital-clock');
        this.feedback = document.getElementById('ui-feedback');
        this.isIn = options.isCheckedIn;
        this.init();
    }

    init() {
        // Simple Clock
        const updateClock = () => {
            this.clock.textContent = new Date().toLocaleTimeString('fr-FR');
        };
        updateClock();
        setInterval(updateClock, 1000);

        this.render();
        this.btn.onclick = () => this.handleAction();
    }

    render() {
        // Using standard Bootstrap colors
        this.btn.classList.remove('btn-success', 'btn-danger');
        this.btn.classList.add(this.isIn ? 'btn-danger' : 'btn-success');
        this.label.textContent = this.isIn ? "{% trans 'CLOCK OUT' %}" : "{% trans 'CLOCK IN' %}";
    }

    handleAction() {
        this.btn.disabled = true;
        this.feedback.innerHTML = `<div class="spinner-border spinner-border-sm text-primary"></div> Locating...`;
        
        navigator.geolocation.getCurrentPosition(
            (pos) => this.runCountdown(pos.coords),
            (err) => this.abort("{% trans 'Location Required' %}"),
            { enableHighAccuracy: true }
        );
    }

    runCountdown(coords) {
        let count = 3;
        this.bar.style.width = '0%';
        
        const timer = setInterval(() => {
            const progress = ((3 - count) / 3) * 100;
            this.bar.style.width = `${progress}%`;
            this.label.textContent = `HOLD ${count}s...`;
            
            if (count <= 0) {
                clearInterval(timer);
                this.bar.style.width = '100%';
                this.submit(coords);
            }
            count--;
        }, 1000);
    }

    async submit(coords) {
        this.label.textContent = "{% trans 'SYNCING...' %}";
        try {
            const res = await fetch(this.options.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.options.csrf
                },
                body: JSON.stringify({
                    in_out: this.isIn ? 1 : 0,
                    latitude: coords.latitude,
                    longitude: coords.longitude,
                    sn: this.options.sn,
                    enroll_id: this.options.enrollId,
                    timestamp: new Date().toISOString()
                })
            });

            if (res.ok) {
                window.location.reload();
            } else {
                this.abort("{% trans 'Error' %}");
            }
        } catch (e) {
            this.abort("{% trans 'Network Error' %}");
        }
    }

    abort(msg) {
        this.feedback.className = "text-danger small fw-bold";
        this.feedback.textContent = msg;
        this.btn.disabled = false;
        this.bar.style.width = '0%';
        this.render();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new AttendanceEngine({
        url: "{% url 'api:list' 'device' 'log' %}",
        csrf: "{{ csrf_token }}",
        sn: "{{ request.user.employee.web_devices.first.sn|default:'' }}",
        enrollId: {{ request.user.employee.registration_number|default:0 }},
        isCheckedIn: !!'{{ attendance.first_checked_at }}'
    });
});
</script>