{% load i18n %}

<div class="row g-3 align-items-center">
  <div class="col-sm-5 border-sm-end px-3">
    <p class="text-muted small text-uppercase fw-bold mb-2">{% trans "Current Status" %}</p>

    <div class="d-flex align-items-center mb-3">
      <div class="rounded-circle me-2 {% if attendance.first_checked_at %}bg-success{% else %}bg-secondary{% endif %}"
           style="width: 12px; height: 12px;"></div>
      <h5 class="mb-0 fw-bold">
        {% if attendance.first_checked_at %}{% trans "On Duty" %}{% else %}{% trans "Off Duty" %}{% endif %}
      </h5>
    </div>

    <div class="small">
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="text-muted">{% trans "In" %}:</span>
        <time datetime="{{ attendance.first_checked_at|date:'c'|default:'' }}" class="fw-bold">
          {{ attendance.first_checked_at|time:"H:i"|default:"--" }}
        </time>
      </div>
      <div class="d-flex justify-content-between py-1">
        <span class="text-muted">{% trans "Out" %}:</span>
        <time datetime="{{ attendance.last_checked_at|date:'c'|default:'' }}" class="fw-bold">
          {{ attendance.last_checked_at|time:"H:i"|default:"--" }}
        </time>
      </div>
    </div>
  </div>

  <div class="col-sm-7 text-center">
    <div id="digital-clock" class="h2 fw-bold mb-0 text-primary">00:00:00</div>
    <p class="text-muted small mb-3">
      {% now "D, d M Y" %}
    </p>

    <div 
      id="ui-feedback" 
      class="small mb-2" 
      style="min-height: 1.25rem;" 
      aria-live="polite"
    ></div>

    <button 
      id="mainPunchBtn" 
      class="btn btn-lg w-100 fw-bold py-3 shadow-sm border-0 position-relative overflow-hidden"
      disabled
    >
      <span class="punch-label">{% trans "Wait..." %}</span>
      <div 
        class="punch-progress position-absolute top-0 start-0 h-100 bg-dark opacity-10" 
        style="width: 0%; transition: width 0.1s linear;"
      ></div>
    </button>
  </div>
</div>

<script>
// Pass translatable strings safely via data attributes (avoid JS template interpolation)
const i18n = {
  clockIn: "{% trans 'CLOCK IN' %}",
  clockOut: "{% trans 'CLOCK OUT' %}",
  hold: "{% trans 'HOLD' %}",
  success: "{% trans 'Success!' %}",
  locationRequired: "{% trans 'Location access required. Please enable GPS and retry.' %}",
  networkError: "{% trans 'Network or server error. Please try again.' %}",
  punchErrorFallback: "{% trans 'Punch failed. Please try again.' %}",
  synchronization: "{% trans 'SYNCHRONISING...' %}",
  wait: "{% trans 'Wait...' %}"
};

class AttendanceEngine {
  constructor(options) {
    this.options = options;
    this.btn = document.getElementById('mainPunchBtn');
    this.bar = this.btn.querySelector('.punch-progress');
    this.label = this.btn.querySelector('.punch-label');
    this.clock = document.getElementById('digital-clock');
    this.feedback = document.getElementById('ui-feedback');
    this.isIn = options.isCheckedIn;
    this.timer = null; // hold countdown timer ref
    this.init();
  }

  init() {
    // Clock (fallback to ISO if fr-FR unsupported)
    const updateClock = () => {
      const now = new Date();
      try {
        this.clock.textContent = now.toLocaleTimeString('fr-FR');
      } catch {
        this.clock.textContent = now.toTimeString().slice(0, 8);
      }
    };
    updateClock();
    this.clockInterval = setInterval(updateClock, 1000);

    this.render();
    this.btn.addEventListener('click', () => this.handleAction());
    this.btn.disabled = false; // enable after setup
  }

  render() {
    this.btn.classList.remove('btn-success', 'btn-danger');
    this.btn.classList.add(this.isIn ? 'btn-danger' : 'btn-success');
    this.label.textContent = this.isIn ? i18n.clockOut : i18n.clockIn;
  }

  handleAction() {
    if (this.btn.disabled) return;

    this.btn.disabled = true;
    this.showFeedback('<div class="spinner-border spinner-border-sm text-primary"></div> Locating...', '');

    navigator.geolocation.getCurrentPosition(
      (pos) => this.runCountdown(pos.coords),
      (err) => {
        let msg = i18n.locationRequired;
        if (err.code === err.PERMISSION_DENIED) {
          msg = "{% trans 'Location access denied. Please allow location and retry.' %}";
        }
        this.abort(msg);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 30000
      }
    );
  }

  runCountdown(coords) {
    let count = 3;

    const update = () => {
      const progress = ((3 - count) / 3) * 100;
      this.bar.style.width = `${progress}%`;
      this.label.textContent = `${i18n.hold} ${count}s...`;

      if (count <= 0) {
        clearInterval(this.timer);
        this.bar.style.width = '100%';
        this.submit(coords);
        return;
      }
      count--;
    };

    update(); // immediate first update
    this.timer = setInterval(update, 1000);
  }

  async submit(coords) {
    this.label.textContent = i18n.synchronization;

    try {
      const res = await fetch(this.options.url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.options.csrf
        },
        body: JSON.stringify({
          in_out: this.isIn ? 1 : 0,
          geofence_center: {
            "type": "Point",
            "coordinates": [coords.longitude, coords.latitude]
          },
          mode: "10",
          event: "0",
          sn: this.options.sn,
          enroll_id: this.options.enrollId,
          timestamp: new Date().toISOString()
        })
      });

      let responseData;
      const contentType = res.headers.get("content-type") || "";
      if (contentType.includes("application/json")) {
        responseData = await res.json().catch(() => null);
      } else {
        responseData = await res.text();
      }

      if (res.ok) {
        this.showFeedback(i18n.success, 'text-success fw-bold');
        // Small delay for feedback visibility before reload
        setTimeout(() => window.location.reload(), 800);
        return;
      }

      // Extract meaningful error message
      let errMsg = i18n.punchErrorFallback;
      if (typeof responseData === 'string' && responseData.trim()) {
        errMsg = responseData;
      } else if (responseData && typeof responseData === 'object') {
        // Try common error fields
        const err = responseData.detail || responseData.message || responseData.error ||
                    responseData.non_field_errors || Object.values(responseData)[0];
        if (err) {
          errMsg = typeof err === 'string' ? err :
                   Array.isArray(err) ? err[0] :
                   JSON.stringify(err);
        }
      }

      this.abort(errMsg);
    } catch (e) {
      console.error('Punch submission failed:', e);
      this.abort(i18n.networkError);
    }
  }

  showFeedback(content, classes = '') {
    this.feedback.className = `small ${classes}`;
    this.feedback.innerHTML = content;
  }

  abort(msg) {
    this.showFeedback(msg, 'text-danger fw-bold');
    this.btn.disabled = false;
    this.bar.style.width = '0%';
    this.render();
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }

  destroy() {
    if (this.clockInterval) clearInterval(this.clockInterval);
    if (this.timer) clearInterval(this.timer);
  }
}

// Initialize on DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  const engine = new AttendanceEngine({
    url: "{% url 'api:list' 'device' 'log' %}",
    csrf: "{{ csrf_token }}",
    sn: "{{ request.user.employee.web_attendance.first.sn|default:'' }}",
    enrollId: {{ request.user.employee.registration_number|default:0 }},
    isCheckedIn: {% if attendance.first_checked_at %}true{% else %}false{% endif %}
  });

  // Optional: cleanup on page unload
  window.addEventListener('beforeunload', () => engine.destroy());
});
</script>