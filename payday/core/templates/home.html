{% extends 'base.html' %}
{% load i18n static %}

{% block content %}
<div class="container-fluid py-4">
    <div id="widgets-grid" class="row g-4">
        {% for widget in widgets %}
            <div class="{{ widget.column }}" data-id="{{ forloop.counter }}">
                <div class="card h-100 shadow-sm border-light">
                    <div class="card-header bg-white border-bottom-0 pt-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="drag-handle text-muted me-2" style="cursor: grab;">
                                <i class="bi bi-grip-vertical fs-5"></i>
                            </div>
                            <h6 class="card-title mb-0 fw-bold text-uppercase small text-muted" style="letter-spacing: 0.5px;">
                                {{ widget.title }}
                            </h6>
                        </div>
                        
                        {% if widget.url %}
                        <a href="{{ widget.url }}" class="btn btn-link btn-sm text-decoration-none p-0">
                            <i class="bi bi-arrow-up-right-square"></i>
                        </a>
                        {% endif %}
                    </div>

                    <div class="card-body">
                        {{ widget.content|safe }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block custom_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const grid = document.getElementById('widgets-grid');
        new Sortable(grid, {
            animation: 200,
            handle: '.drag-handle',
            onEnd: function () {
                const order = Array.from(grid.children).map(el => el.getAttribute('data-id'));
                localStorage.setItem('hrms-layout-v1', JSON.stringify(order));
            },
        });

        const savedOrder = JSON.parse(localStorage.getItem('hrms-layout-v1'));
        if (savedOrder) {
            savedOrder.forEach(id => {
                const item = grid.querySelector(`[data-id="${id}"]`);
                if (item) grid.appendChild(item);
            });
        }

        document.getElementById('reset-layout').onclick = () => {
            localStorage.removeItem('hrms-layout-v1');
            window.location.reload();
        };
    });
</script>
{% endblock %}