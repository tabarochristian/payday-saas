{# templates/payroll/slip.html #}
{% load i18n static humanize mathfilters %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "Fiche de paie" %}{% endblock %}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
          crossorigin="anonymous">

    <style>
        body { font-size: 11px; }
        .organization-logo { max-height: 60px; }
        .payslip-table th, .payslip-table td { vertical-align: middle; }
        dl.row dt, dl.row dd { margin-bottom: 0.2rem; }
        .page-break { page-break-after: always; }

        @media print {
            body { font-size: 12px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="container-fluid my-3">

{% block content %}
    {% for obj in qs %}
    <section class="page-break">

        <!-- Header -->
        <div class="row align-items-center mb-3">
            <div class="col-6">
                {% if sub_organization and sub_organization.logo %}
                    <img src="{{ sub_organization.logo.url }}"
                         alt="{{ sub_organization.name }}"
                         class="organization-logo img-fluid mb-2"
                         loading="lazy">
                {% endif %}
            </div>
            <div class="col-6 text-end no-print">
                <small class="text-muted">
                    {% trans "Généré le" %} : {% now "d/m/Y" %}
                </small>
            </div>
        </div>

        <!-- Employee Info -->
        <div class="row mb-3">
            <div class="col-md-6">
                {% include "payroll/includes/_employee_info_left.html" with obj=obj %}
            </div>
            <div class="col-md-6">
                {% include "payroll/includes/_employee_info_right.html" with obj=obj %}
            </div>
        </div>

        <hr class="my-2">

        <!-- Earnings & Deductions -->
        <div class="row">
            {% with items=obj.itempaid_set.all %}
                <div class="col-md-6">
                    {% include "payroll/includes/_earnings_table.html" with items=items %}
                </div>
                <div class="col-md-6">
                    {% include "payroll/includes/_deductions_table.html" with items=items %}
                </div>
            {% endwith %}
        </div>

        <!-- Summary -->
        <div class="row mt-3">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-5">{% trans "Plafond CNSS" %}</dt>
                    <dd class="col-7">: {{ obj.social_security_threshold|default:0|floatformat:2|intcomma }}</dd>

                    <dt class="col-5">{% trans "Brut imposable" %}</dt>
                    <dd class="col-7">: {{ obj.taxable_gross|default:0|floatformat:2|intcomma }}</dd>
                </dl>
            </div>
            <div class="col-md-6 text-end">
                <h5 class="mb-0 fw-bold">
                    {% trans "NET A PAYER" %}: 
                    <span class="text-primary">
                        {{ obj.net|default:0|floatformat:2|intcomma }}
                    </span>
                </h5>
                <small class="text-muted">({{ obj.payroll.metadata.currency|default:'CDF' }})</small>
            </div>
        </div>

        <hr class="my-3">

        <!-- Footer Info -->
        <div class="row mb-2">
            <div class="col">
                <dl class="row">
                    <dt class="col-3">{% trans "Grade/Categorie" %}</dt>
                    <dd class="col-9">: {{ obj.employee.designation.group|default:obj.employee.grade.name|title }}</dd>

                    <dt class="col-3">{% trans "Période" %}</dt>
                    <dd class="col-9">: {{ obj.payroll.start_dt|date:"d/m/Y" }} – {{ obj.payroll.end_dt|date:"d/m/Y" }}</dd>
                </dl>
            </div>
        </div>

        <!-- Signature Table -->
        <div class="row mt-4">
            <div class="col">
                <table class="table table-bordered table-sm text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "Matricule" %}</th>
                            <th>{% trans "Nom complet" %}</th>
                            <th>{% trans "Centre" %}</th>
                            <th>{% trans "Net à payer" %}</th>
                            <th>{% trans "Signature" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="height: 50px;">
                            <td>{{ obj.employee.registration_number }}</td>
                            <td>{{ obj.employee.last_name }} {{ obj.employee.middle_name }}</td>
                            <td>{{ obj.employee.branch.name }}</td>
                            <td>{{ obj.net|default:0|floatformat:2|intcomma }}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </section>
    {% endfor %}
{% endblock %}

</body>
</html>
